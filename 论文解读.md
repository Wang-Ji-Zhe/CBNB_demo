 <h2 align="center">HYBRIDS OF CONSTRAINT-BASED AND NOISE-BASED</h2>

 <h2 align="center">ALGORITHMS FOR CAUSAL DISCOVERY FROM TIME SERIES</h2>



## 1.  概念定义

在这一小节解释一些后面可能会用到的名词和概念。

1. **最大时间后滞**：两个变量之间的因果关系所涉及的最大的时间延迟。
2. **时间一致性**：因果关系不会随着时间的变化而改变。
3. **反馈循环**：一般情况下，原因会在效果之前发生，但是如果两个变量之间存在反馈式的相互影响，就会出现循环，无法分清原因和效果谁先发生。
4. **马尔可夫条件**：在给定当前状态和所有过去状态的情况下，随机过程的未来状态仅依赖于当前状态，与过去状态无关。
5. **因果忠诚性假设**：数据中观察到的**条件独立性**都是由真实的因果图决定的，而不是由其他因素造成的。通俗来讲就是：数据当中任何**直接的、间接的**相关性和独立性都会体现在因果图上。



## 2.  因果图类型

1. **全时间因果图（Full-time causal graph，FTCG）**：一种用来表示时间序列之间因果关系的最详细的图形，它包含了所有可能的时间延迟，并且所有的边都是有向的。（只有全时间因果图不一定满足时间一致性，其他图都满足时间一致性）
1. **窗口因果图（Window causal graph，WCG）**：一种用来表示时间序列之间因果关系的较为简化的图形，它只考虑最大时间后滞内的因果关系，并且所有的边都是有向的。
1. **扩展总结因果图（Extended summary causal graph，ECG）**：一种用来表示时间序列之间因果关系的抽象图形，它可以区分瞬时关系和滞后关系，但不给出滞后关系的具体时间延迟。
1. **总结因果图（Summary causal graph，SCG）**：一种用来表示时间序列之间因果关系的最简单的图形，它完全忽略了时间信息，只显示哪些变量之间存在因果关系，而不区分瞬时关系和滞后关系。（只有总结因果图可能存在循环，其他图都不存在循环）

<img src=".\images\jdlw_01.png" style="zoom:60%;" />



## 3.  算法族

1. **Granger Causality**：
    - 基本思想：若变量X对变量Y有影响，那么X的过去的信息应该能够帮助预测Y的未来的值，而不是只用Y自己的过去的信息。
    - 优点：比较简单和直观，而且可以用统计检验来验证因果关系是否存在。
    - 缺点：只能处理线性关系，且必须满足因果优先性，即原因必须在效果之前发生，因此不能处理存在反馈循环的情况。
2. **Noise-based approaches**：
    - 基本思想：利用因果不对称性在数据中产生的噪声来定向因果图。也就是说，如果一个变量X对另一个变量Y有影响，那么X的噪声应该能够传递到Y，而Y的噪声则不会传递到X。
    - 优点：不需要满足马尔科夫假设和因果忠诚性假设，也不需要做条件独立性测试，只需要做回归和噪声检验。
    - 缺点：要求**噪声必须具有一定的特征**（例如非高斯性），是的噪声可以从数据中分离出来。
3. **Constraint-based approaches**：
    - 基本思想：利用条件独立性测试来剪枝和定向因果图。也就是说，如果一个变量X对另一个变量Y没有影响，那么X和Y在给定其他变量的条件下应该是独立的，因此可以消除X和Y之间的边；如果一个变量X对另一个变量Y有影响，那么X和Y在给定其他变量的条件下应该是相关的，因此可以确定X和Y之间的边的方向。
    - 优点：以处理非线性和非高斯的关系，而且可以发现不同类型的因果图，比如窗口因果图、扩展总结因果图等。
    - 缺点：需要假设数据满足因果马尔可夫条件和**因果忠诚性假设**。



## 4.  前置算法

1. **NBCB$^{acyclic}$**：
    - 这是一种混合方法，结合了基于噪声的方法和基于约束的方法来发现时间序列之间的总结因果图（SCG）。
    - 这种方法在某些假设被违反时，可以比非混合方法有更好的结果。
    - 但是，这种方法依旧假设总结因果图是无环的，也就是说，变量之间没有反馈循环的关系。
    - **而本文提出的方法，就是对 NBCB$^{acyclic}$ 的改进，使其可以处理图中带环（反馈循环）的情况。**



## 5.  基于约束和基于噪声的混合算法

####     ◽ 假设条件：

1. 混合算法结合了基于约束的方法，基于约束的方法要求满足因果忠诚性假设，但是混合算法只需要满足因果忠诚型假设的<u>减弱版</u>——**邻接忠诚性假设**：数据中观察到的**边缘独立性**都是由真实的因果图决定的，而不是由其他因素造成的。通俗来讲就是：数据当中任何**直接的**相关性和独立性都会体现在因果图上。
2. 混合算法结合了基于噪声的方法，基于噪声的方法要求噪声必须具有一定特征，混合算法也有同样的要求。

#####     ◽ 不同框架及版本：

作者基于 “基于约束和基于噪声的混合算法” 这一思想提出了两种框架：

1. **NBCB**：首先使用基于噪声的算法对图进行定向，然后使用基于约束的算法对图进行剪枝
2. **CBNB**：首先使用基于约束的算法对图进行剪枝，然后使用基于噪声的算法对图进行定向

对于不同的框架，根据选择的基于约束的算法的不同，又可以分为四个版本：

| 算法名称 | 基于约束的算法 | 基于噪声的算法 |
| :------: | :------------: | :------------: |
|  CBNB-w  |     PCMCI+     |    VLiNGAM     |
|  NBCB-w  |     PCMCI+     |    VLiNGAM     |
|  CBNB-e  |     PCGCE      |    VLiNGAM     |
|  NBCB-e  |     PCGCE      |    VLiNGAM     |

注：CBNB-e 和 NBCB-e的代码没有跑通，因此先不介绍PCGCE算法。后面会介绍 **PC**、**PCMCI**、**PCMCI+**、**VLiNGAM** 算法。



## 6.  基于约束的算法介绍

###   👉 PC算法：

##### 	◽ 理论依据：

1. 顶点A和顶点B在有向图中相邻，当且仅当：在全集的任意不包含A和B的子集的条件下，A和B都相关；
2. 顶点A、顶点B、顶点C在有向图中形成A → B ← C，当且仅当：在全集的任意包含B、不包含A和C的子集的条件下，A和C都相关。

##### ◽ 算法步骤：

1. 使用所有节点构建一个全连接无向图；
2. 对于任意两个节点A和B，考虑A和B的所有相邻节点所构成的集合，如果该集合存在一个不包含A和B的子集，使得在这个子集的条件下，A和B独立，则去掉A和B之间的边；
3. 对于形如A -- B -- C的任意三个顶点A、B、C，考虑全集，如果不存在一个包含B而不包含A和C的子集，使得在这个子集的条件下，A和C独立，则把A -- B -- C改写为A → B ← C；
4. 重复以下过程，直到没有可以改变的无向边：
    - 若已有A → B，存在C使得C和B相邻但是C不和A相邻，并且B没有箭头指向其他节点，就将无向边B -- C改写为B → C；
    - 如果A到B之间有一条有向路径，并且A和B相邻，就将无向边A -- B改写为A → B。

### 👉 PCMCI算法：

——论文：Detecting and quantifying causal associations in large nonlinear time series datasets

##### ◽ 理论依据：

1. 如果一个变量X在滞后时间后对另一个变量Y有因果作用，那么在给定Y和X的父节点（即直接影响它们的变量）的情况下，X和Y之间应该不是条件独立的。换句话说，如果X$_{t−}$和Y$_{t}$在给定双方父节点的情况下是条件独立的，那么我们可以认为X$_{t−}$ → Y$_{t}$这条因果链不存在。

##### ◽ 算法步骤：

1. PC条件选择：使用PC算法，去除无关边、确定无向边方向，将无向图转换为有向图；
2. MCI条件独立性检验：利用上述理论依据来判断两个变量之间是否存在滞后的因果作用。

### 👉 PCMCI+算法：

——论文：Discovering contemporaneous and lagged causal relations in autocorrelated nonlinear time series datasets

##### ◽ 算法思想：

基于PCMCI算法做出若干改进，使得算法速度更快、适应性更强：

1. 优化了同时条件集的选择，提高了因果关系的效应大小（即因果信号和噪声的比值）。效应大小越大，检测因果关系的能力越强。
2. 通过考虑滞后变量的父节点，消除了自相关（即一个变量在不同时间点的取值之间存在相关性）；
3. 可以灵活地使用不同的条件独立性检验，适用于线性和非线性、离散和连续、单变量和多变量的时间序列数据。



## 7.  基于噪声的算法介绍

### 👉 VarLiNGAM算法：

——论文：Causal modelling combining instantaneous and lagged eﬀects: an identiﬁable model based on non-Gaussianity

##### ◽ 假设条件：

假设外部噪声（外部干扰项）符合以下条件：

1. 非高斯：即噪声的概率分布不是正态分布；
2. 相互独立：即噪声之间没有任何相关性或依赖性；
3. 时间无关：即噪声在不同的时间点之间没有任何相关性或依赖性。

##### ◽ 算法步骤：

1. 用一个矩阵序列B$_τ$表示，$τ$ = 0, …, k。B$_τ$(i, j)表示从x$_j$(t - τ)到x$_i$(t)的因果效应，其中i, j = 1, …, n是变量的索引，t = 1, …, T是时间的索引，k是自回归模型的阶数；
2. 使用最小二乘法或其他常用的回归方法，对矩阵序列B$_τ$进行估计；
3. 计算残差，也就是实际观测到的数据与模型预测之间的差异；
4. 对残差进行LiNGAM分析，得到瞬时效应矩阵（表示在同一时间点内，每个变量对其他变量的影响程度），LiNGAM分析是一种基于非高斯性和因果性假设的因果分析方法；
5. 根据公式计算滞后效应矩阵（表示在不同时间点之间，每个变量对其他变量的影响程度）。

